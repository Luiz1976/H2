import { apiService } from '../services/apiService';

export const resultadosService = {
  /**
   * Salvar resultado de um teste usando a API local
   */
  async salvarResultado(resultado: any): Promise<any> {
    try {
      console.log('üîç [RESULTADOS-SERVICE] Iniciando salvamento via API local');
      console.log('üìä [RESULTADOS-SERVICE] Dados recebidos:', JSON.stringify(resultado, null, 2));
      
      // Preparar dados para API (converter snake_case para camelCase)
      const dadosApi = {
        testeId: resultado.teste_id || null,
        usuarioId: resultado.usuario_id || null,
        pontuacaoTotal: Number(resultado.pontuacao_total),
        tempoGasto: resultado.tempo_gasto ? Number(resultado.tempo_gasto) : undefined,
        sessionId: resultado.session_id,
        metadados: resultado.metadados,
        status: resultado.status || 'concluido',
        userEmail: resultado.user_email || undefined,
        empresaId: resultado.empresa_id || null,
      };
      
      console.log('üîç [RESULTADOS-SERVICE] Enviando para API local:', JSON.stringify(dadosApi, null, 2));
      
      // Salvar via API local
      const resultadoSalvo = await apiService.salvarResultadoTeste(dadosApi);
      
      console.log('‚úÖ [RESULTADOS-SERVICE] Resultado salvo com sucesso via API:', resultadoSalvo);
      
      // Se √© um colaborador logado e o teste foi conclu√≠do, marcar como indispon√≠vel
      const token = localStorage.getItem('authToken');
      const user = localStorage.getItem('currentUser');
      
      if (token && user && resultado.teste_id) {
        try {
          const userData = JSON.parse(user);
          
          // Apenas marcar como conclu√≠do se for um colaborador
          if (userData.role === 'colaborador') {
            console.log('üîí [RESULTADOS-SERVICE] Marcando teste como conclu√≠do para colaborador...');
            
            const response = await fetch('/api/teste-disponibilidade/marcar-concluido', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                testeId: resultado.teste_id,
                colaboradorId: userData.userId
              })
            });

            if (response.ok) {
              console.log('‚úÖ [RESULTADOS-SERVICE] Teste marcado como indispon√≠vel com sucesso');
            } else {
              const error = await response.json();
              console.error('‚ö†Ô∏è [RESULTADOS-SERVICE] Erro ao marcar teste como indispon√≠vel:', error);
            }
          }
        } catch (error) {
          // N√£o bloquear o fluxo se falhar ao marcar como indispon√≠vel
          console.error('‚ö†Ô∏è [RESULTADOS-SERVICE] Erro ao processar marca√ß√£o de disponibilidade:', error);
        }
      }
      
      return resultadoSalvo;
      
    } catch (error) {
      console.error('‚ùå [RESULTADOS-SERVICE] Erro ao salvar:', error);
      console.error('‚ùå [RESULTADOS-SERVICE] Stack trace:', error instanceof Error ? error.stack : 'Sem stack trace');
      throw error;
    }
  },
};
